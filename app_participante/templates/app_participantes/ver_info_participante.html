{% load static %}
<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Eventos Inscritos</title>
  <link rel="stylesheet" href="{% static 'app_participante/css/style.css' %}" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet" />
</head>
<body style="background-image: url("{% static 'app_participante/image/fondo_admin.png' %}");">

<header class="position-relative py-3 mb-4 header-participante">
  <div class="container position-relative text-center">
    <a href="{% url 'inicio_visitante' %}" class="btn btn-light position-absolute start-0 top-50 translate-middle-y ms-2">
      <i class="fas fa-arrow-left"></i> Regresar
    </a>
    <h1 class="text-white m-0 fs-4">Eventos Inscritos</h1>
  </div>
</header>

<main>
  <h2 class="text-center my-4">Mis Inscripciones Participante</h2>

  <div class="contenedor-principal-de-eventos d-flex flex-wrap justify-content-center gap-3">
    {% if eventos %}
      {% for evento in eventos %}
        <div class="card" style="width: 18rem;">
          <img src="{{ evento.par_eve_evento_fk.eve_imagen.url }}" class="card-img-top" alt="{{ evento.par_eve_evento_fk.eve_nombre }}" />
          <div class="card-body">
            <h5 class="card-title">{{ evento.eve_nombre }}</h5>
            <h6 class="card-subtitle mb-2 text-body-secondary">
              <i class="fa-solid fa-calendar"></i> {{ evento.eve_fecha_inicio }} - {{ evento.eve_fecha_fin }}
            </h6>

            {% if evento.par_eve_estado == "Admitido" %}
              <div>Estado: <span style="color: rgb(39, 119, 39);">{{ evento.par_eve_estado }}</span></div>
              {% if evento.calificacion == "Sin calificar" %}
                <span class="text-muted fst-italic">Calificación: {{ evento.calificacion }}</span>
              {% else %}
                <span class="badge bg-success">Calificación: {{ evento.calificacion }}</span>
              {% endif %}
              <button
                class="btn btn-primary mt-2 btn-ver-mas"
                data-bs-toggle="modal"
                data-bs-target="#modalVerEvento"
                data-evento-id="{{ evento.eve_id }}"
                data-cedula="{{ cedula_participante }}"
              >
                <i class="fa-solid fa-eye"></i> Ver Información
              </button>

            {% elif evento.par_eve_estado == "Rechazado" %}
              <div>Estado: <span style="color: rgb(158, 28, 28);">{{ evento.par_eve_estado }}</span></div>
              <button
                class="btn btn-danger mt-2 btn-cancelar"
                data-bs-toggle="modal"
                data-bs-target="#modalConfirmarCancelar"
                data-evento-id="{{ evento.eve_id }}"
                data-cedula="{{ cedula_participante }}"
              >
                Cancelar mi Inscripción
              </button>

            {% else %}
              <div>Estado: <span style="color: rgb(199, 80, 12);">{{ evento.par_eve_estado }}</span></div>
              <button
                class="btn btn-warning mt-2 btn-modificar"
                data-bs-toggle="modal"
                data-bs-target="#modalModificarInscripcion"
                data-evento-id="{{ evento.eve_id }}"
                data-cedula="{{ cedula_participante }}"
              >
                Modificar Información de Inscripción
              </button>
              <button
                class="btn btn-danger mt-2 btn-cancelar"
                data-bs-toggle="modal"
                data-bs-target="#modalConfirmarCancelar"
                data-evento-id="{{ evento.eve_id }}"
                data-cedula="{{ cedula_participante }}"
              >
                Cancelar mi Inscripción
              </button>
            {% endif %}
          </div>
        </div>
      {% endfor %}
    {% else %}
      <div class="text-center my-5">
        <h4 class="text-muted">No estás inscrito en ningún evento actualmente.</h4>
        <p class="text-secondary">Explora los eventos disponibles y regístrate para participar.</p>
      </div>
    {% endif %}
  </div>
</main>

<!-- Modal: Ver Información del Evento -->
<div
  class="modal fade"
  id="modalVerEvento"
  tabindex="-1"
  aria-labelledby="modalVerEventoLabel"
  aria-hidden="true"
>
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="modalVerEventoLabel">Información del Evento</h5>
        <button
          type="button"
          class="btn-close"
          data-bs-dismiss="modal"
          aria-label="Cerrar"
        ></button>
      </div>
      <div class="modal-body" id="contenidoModalVerEvento">
        <p>Cargando información...</p>
      </div>
      <div class="modal-footer">
        <button
          type="button"
          class="btn btn-secondary"
          data-bs-dismiss="modal"
        >
          Cerrar
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Modal: Confirmar Cancelar Inscripción -->
<div
  class="modal fade"
  id="modalConfirmarCancelar"
  tabindex="-1"
  aria-labelledby="modalConfirmarCancelarLabel"
  aria-hidden="true"
>
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <form id="formCancelarInscripcion" method="post" action="{% url 'app_participante:cancelar_inscripcion' %}
">
        {% csrf_token %}
        <div class="modal-header">
          <h5 class="modal-title" id="modalConfirmarCancelarLabel">
            Confirmar Cancelación
          </h5>
          <button
            type="button"
            class="btn-close"
            data-bs-dismiss="modal"
            aria-label="Cerrar"
          ></button>
        </div>
        <div class="modal-body">
          <p>¿Está seguro que desea cancelar su inscripción en este evento?</p>
          <input type="hidden" name="evento_id" id="inputEventoCancelar" />
          <input type="hidden" name="participante_cedula" value="{{ cedula_participante }}" />
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
            No
          </button>
          <button type="submit" class="btn btn-danger">Sí, Cancelar</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Modal: Modificar Inscripción -->
<div
  class="modal fade"
  id="modalModificarInscripcion"
  tabindex="-1"
  aria-labelledby="modalModificarInscripcionLabel"
  aria-hidden="true"
>
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content">
      <form id="formModificarInscripcion" method="post" action="{% url 'app_participante:modificar_inscripcion' %}">
        {% csrf_token %}
        <div class="modal-header">
          <h5 class="modal-title" id="modalModificarInscripcionLabel">
            Modificar Información de Inscripción
          </h5>
          <button
            type="button"
            class="btn-close"
            data-bs-dismiss="modal"
            aria-label="Cerrar"
          ></button>
        </div>
        <div class="modal-body">
          <input type="hidden" name="evento_id" id="inputEventoModificar" />
          <input type="hidden" name="participante_cedula" value="{{ cedula_participante }}" />

          <!-- Aquí los campos para modificar -->
          <div class="mb-3">
            <label for="documentos" class="form-label">Documentos</label>
            <input
              type="text"
              class="form-control"
              id="documentos"
              name="documentos"
              required
            />
          </div>
          <div class="mb-3">
            <label for="estado" class="form-label">Estado</label>
            <select class="form-select" id="estado" name="estado" required>
              <option value="Pendiente">Pendiente</option>
              <option value="Admitido">Admitido</option>
              <option value="Rechazado">Rechazado</option>
            </select>
          </div>
          <!-- Puedes agregar más campos según tu modelo -->
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
            Cancelar
          </button>
          <button type="submit" class="btn btn-primary">Guardar Cambios</button>
        </div>
      </form>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<script>
  // Modal Ver Información del Evento - carga info vía AJAX
  var modalVerEvento = document.getElementById("modalVerEvento");
  modalVerEvento.addEventListener("show.bs.modal", function (event) {
    var button = event.relatedTarget;
    var eventoId = button.getAttribute("data-evento-id");
    var modalBody = modalVerEvento.querySelector("#contenidoModalVerEvento");

    modalBody.innerHTML = "<p>Cargando información...</p>";

    fetch(`/api/evento/${eventoId}/detalle/`)
  .then((response) => {
    if (!response.ok) throw new Error("Error en la respuesta");
    return response.json();
  })
  .then((data) => {
    var contenido = `
      <h3>${data.nombre}</h3>
      <p><strong>Fecha inicio:</strong> ${data.fecha_inicio}</p>
      <p><strong>Fecha fin:</strong> ${data.fecha_fin}</p>
      <p><strong>Descripción:</strong> ${data.descripcion}</p>
      <p><strong>Lugar:</strong> ${data.lugar}</p>
    `;
    modalBody.innerHTML = contenido;
  })
  .catch((error) => {
    modalBody.innerHTML = `<p>Error al cargar la información del evento: ${error.message}</p>`;
    console.error(error);
  });

  // Modal Confirmar Cancelar - setear id evento al formulario
  var modalConfirmarCancelar = document.getElementById(
    "modalConfirmarCancelar"
  );
  modalConfirmarCancelar.addEventListener("show.bs.modal", function (event) {
    var button = event.relatedTarget;
    var eventoId = button.getAttribute("data-evento-id");
    var inputEvento = modalConfirmarCancelar.querySelector("#inputEventoCancelar");
    inputEvento.value = eventoId;
  });

  // Modal Modificar Inscripción - cargar datos al modal
  var modalModificarInscripcion = document.getElementById("modalModificarInscripcion");
  modalModificarInscripcion.addEventListener("show.bs.modal", function (event) {
    var button = event.relatedTarget;
    var eventoId = button.getAttribute("data-evento-id");
    var modal = modalModificarInscripcion;

    modal.querySelector("#inputEventoModificar").value = eventoId;

    // Aquí podrías hacer fetch para cargar info previa de inscripción
    // Ejemplo (ajustar ruta y campos según tu API):

    fetch(`/api/inscripcion/${eventoId}/participante/{{ cedula_participante }}/`)
      .then((response) => response.json())
      .then((data) => {
        modal.querySelector("#documentos").value = data.documentos || "";
        modal.querySelector("#estado").value = data.estado || "Pendiente";
      })
      .catch(() => {
        modal.querySelector("#documentos").value = "";
        modal.querySelector("#estado").value = "Pendiente";
      });
  });
</script>

</body>
</html>
