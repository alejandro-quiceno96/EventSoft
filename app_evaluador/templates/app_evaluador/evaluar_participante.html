{% extends "app_evaluador/base.html" %}
{% load static %}

{% block title %}
    {{ evaluador_nombre|default:'Evaluador' }}
{% endblock %}

{% block url_volver %}{% url 'app_evaluador:ver_participantes' evento.id %}{% endblock %}

{% block content %}
<style>
    .card-criterio {
        transition: box-shadow 0.3s, border 0.3s;
        border: 2px solid transparent;
    }

    .card-criterio.active {
        border-color: #007832;
        box-shadow: 0 0 10px rgba(255, 88, 0, 0.3);
    }
</style>

<div class="container">
    <h2 class="text-center mb-4 text-orange">Evaluar Participante</h2>
    <h5 class="text-center mb-4">{{ participante.par_nombre }} - {{ evento.eve_nombre }}</h5>

    <div class="alert alert-info">
        <strong>Importante:</strong> Cada puntaje debe estar entre 0 y 100. El comentario es opcional.
    </div>

    <form id="form-evaluacion" method="POST" action="{% url 'app_evaluador:evaluar_participante' evento.id participante.id evaluador.id %}">
        {% csrf_token %}

        <div class="row g-4">
            {% for criterio in criterios %}
            <div class="col-md-6 col-lg-4">
                <div class="card card-criterio h-100 shadow-sm">
                    <div class="card-body d-flex flex-column">
                        <h5 class="card-title text-orange">{{ criterio.cri_descripcion }}</h5>
                        <p class="card-subtitle mb-2 text-muted">Peso: {{ criterio.cri_peso }}%</p>

                        <label class="mt-2">Puntaje (0-100):</label>
                        <input 
                            type="number" 
                            name="puntaje_{{ criterio.id }}" 
                            class="form-control puntaje-input mb-2" 
                            min="0" max="100" required 
                            placeholder="Ingrese puntaje" />

                        <label>Comentario:</label>
                        <textarea 
                            name="comentario_{{ criterio.id }}" 
                            class="form-control comentario-input mb-2" 
                            placeholder="Comentario opcional..." 
                            rows="3"></textarea>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>

        <div id="error-message" class="alert alert-danger mt-4" style="display: none;">
            Cada puntaje debe estar entre 0 y 100. Corrige los valores antes de guardar.
        </div>

        <div class="mt-4 d-flex justify-content-between m-2">
            <a href="{% url 'app_evaluador:ver_participantes' evento.id %}" class="btn btn-danger">Cancelar</a>
            <button type="submit" class="btn-orange">Guardar Calificación</button>
        </div>
    </form>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        // Validación al enviar
        document.getElementById('form-evaluacion').addEventListener('submit', function (e) {
            let valid = true;
            document.querySelectorAll('.puntaje-input').forEach(input => {
                const value = parseFloat(input.value);
                if (isNaN(value) || value < 0 || value > 100) {
                    valid = false;
                }
            });

            if (!valid) {
                e.preventDefault();
                document.getElementById('error-message').style.display = 'block';
            } else {
                document.getElementById('error-message').style.display = 'none';
            }
        });

        // Activar borde naranja en foco
        const inputs = document.querySelectorAll('.puntaje-input, .comentario-input');
        inputs.forEach(input => {
            input.addEventListener('focus', function () {
                this.closest('.card-criterio').classList.add('active');
            });

            input.addEventListener('blur', function () {
                this.closest('.card-criterio').classList.remove('active');
            });
        });
    });
</script>
{% endblock %}
