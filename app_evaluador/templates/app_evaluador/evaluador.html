{% extends "app_evaluador/base.html" %}

{% block title %}Criterios de Evaluación{% endblock %}

{% block extra_styles %}
<div class="container mt-5">
    <div class="mt-3">
        <a href="{% url 'app_evaluador:inicio_evaluador' %}" class="btn btn-danger">Volver al Evaluador</a>
    </div>

    <h2 class="mb-4">Criterios de Evaluación</h2>

    <div class="alert alert-info" role="alert">
        <strong>Nota:</strong> Los criterios de evaluación son fundamentales para la calificación de los participantes.
        <form id="form-criterios" method="POST">
            {% csrf_token %}
            <div class="mb-3">
                <label for="nuevo_criterio" class="form-label">Nuevo Criterio:</label>
                <div class="input-grupos d-flex gap-2">
                    <input type="text" class="form-control" name="criterio" placeholder="Descripción" required>
                    <input type="number" class="form-control" name="porcentaje" placeholder="%" min="0" max="100" required>
                    <input type="hidden" name="evento_id" value="{{ evento_actual.id }}">
                    <button type="submit" class="btn btn-success">Agregar</button>
                </div>
            </div>
        </form>
    </div>

    <div id="total-porcentaje" class="alert alert-secondary">
        Porcentaje total: <span id="porcentaje-total">0</span>%
    </div>

    <table class="table table-bordered" id="tabla-criterios">
        <thead class="table-dark">
            <tr>
                <th>Descripción</th>
                <th>Porcentaje</th>
                <th>Acciones</th>
            </tr>
        </thead>
        <tbody>
            {% for criterio in criterios %}
            <tr data-id="{{ criterio.id }}">
                <td><input type="text" value="{{ criterio.descripcion }}" class="form-control" disabled></td>
                <td><input type="number" class="form-control" value="{{ criterio.peso }}" disabled></td>
                <td>
                    <button class="btn btn-primary btn-modificar">Modificar</button>
                    <button class="btn btn-danger btn-eliminar">Eliminar</button>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function () {
    const csrftoken = '{{ csrf_token }}';

    document.querySelectorAll('.btn-eliminar').forEach(button => {
        button.addEventListener('click', function () {
            const row = this.closest('tr');
            const criterioId = row.getAttribute('data-id');

            fetch(`/criterio/${criterioId}/eliminar/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': csrftoken
                }
            })
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    row.remove();
                } else {
                    alert('Error: ' + data.error);
                }
            })
            .catch(err => {
                console.error(err);
                alert('Error al eliminar criterio');
            });
        });
    });
});
</script>
{% endblock %}
