{% extends "app_evaluador/base.html" %}
{% load static %}

{% block title %}
    {{ evaluador_nombre|default:'Evaluador' }}
{% endblock %}


{% block content %}
<link rel="stylesheet" href="{% static 'app_administrador/css/criteriosadmin.css' %}">
<a href="{% url 'app_evaluador:principal_evaluador' %}" class="btn btn-detalle-calificacion mb-2">
            <i class="fa-solid fa-arrow-left"></i></i> Volver al panel principal
    </a>
<h2 class="text-center my-4 text-orange">Participantes admitidos del evento: {{ evento.eve_nombre }}</h2>

<div class="row g-4 justify-content-center">
    {% for participante in participantes %}
    <div class="col-lg-4 col-md-6 col-sm-12">
        <div class="card participante-card shadow-sm h-100">
            <div class="card-body d-flex flex-column justify-content-between">
                <h5 class="card-title text-center text-dark">{{ participante.par_eve_participante_fk.usuario.first_name }} {{ participante.par_eve_participante_fk.usuario.last_name }}</h5>
                <div class="d-grid gap-2 mt-3">
                   {% if participante.par_eve_participante_fk.id in evaluados_dict %}
                        <!-- Mostrar botón si este evaluador ya calificó -->
                        <button
    class="btn-orange btn-ver-calificaciones"
    data-url="{% url 'app_evaluador:api_calificaciones' evento.id participante.par_eve_participante_fk.id evaluador_id %}"
  data-bs-toggle="modal"
    data-bs-target="#modalCalificaciones"
>
    Ver Calificaciones
</button>

                   {% else %}
                        <!-- Botón para evaluar si aún no ha sido calificado por este evaluador -->
                        <a href="{% url 'app_evaluador:evaluar_participante' evento.id participante.par_eve_participante_fk.id evaluador_id %}" 
   class="btn-orange">Evaluar</a>

                   {% endif %}
                </div>
            </div>
        </div>
    </div>
    {% empty %}
    <p class="text-center text-muted">No hay participantes admitidos en este evento.</p>
    {% endfor %}
</div>

 
<!-- Ranking -->
<div class="mt-5">
    <div class="d-flex justify-content-end mt-3 p-2">
        <a href="{% url 'administrador:descargar_ranking_pdf' evento.id %}" class="btn btn-outline-success" target="_blank">
            <i class="fa-solid fa-file-pdf"></i> Descargar Ranking (PDF)
        </a>
    </div>
    <h3 class="text-orange"><span class="ranking-icon">🏆</span> Ranking de Promedios</h3>
    <div class="table-responsive">
        <table class="table table-bordered table-striped mt-3">
            <thead class="table-orange text-white text-center">
                <tr>
                    <th>Posición</th>
                    <th>Nombre</th>
                    <th>Promedio</th>
                </tr>
            </thead>
            <tbody>
                {% for participante in ranking %}
                <tr>
                    <td class="text-center">
                        {% if forloop.counter == 1 %}
                            <span class="badge bg-warning text-dark">🥇 {{ forloop.counter }}</span>
                        {% elif forloop.counter == 2 %}
                            <span class="badge bg-secondary">🥈 {{ forloop.counter }}</span>
                        {% elif forloop.counter == 3 %}
                            <span class="badge" style="background-color: #cd7f32;">🥉 {{ forloop.counter }}</span>
                        {% else %}
                            {{ forloop.counter }}
                        {% endif %}
                    </td>
                    <td>{{ participante.par_eve_participante_fk.usuario.first_name }} {{ participante.par_eve_participante_fk.usuario.last_name }}</td>
                    <td class="text-center">{{ participante.par_eve_calificacion_final|floatformat:2 }}</td>
                </tr>
                {% empty %}
                <tr>
                    <td colspan="3" class="text-center text-muted">Aún no hay calificaciones registradas.</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<!-- Modal de Calificaciones -->
<div class="modal fade" id="modalCalificaciones" tabindex="-1" aria-labelledby="modalCalificacionesLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header bg-orange text-white">
        <h5 class="modal-title" id="modalCalificacionesLabel">Calificaciones del Participante</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
      </div>
      <div class="modal-body" id="modal-calificaciones-body">
        <div class="text-center text-muted">Cargando calificaciones...</div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
      </div>
    </div>
  </div>
</div>

<!-- Modal confirmación -->
<div id="registroModal" class="modal">
    <div class="modal-content">
        <span class="close">&times;</span>
        <h3 id="modalTitulo"></h3>
        <p id="modalMensaje"></p>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        const params = new URLSearchParams(window.location.search);
        const tipoRegistro = params.get('calificacion');
        const modal = document.getElementById('registroModal');
        const modalTitulo = document.getElementById('modalTitulo');
        const modalMensaje = document.getElementById('modalMensaje');

        if (tipoRegistro) {
            let titulo = '';
            let mensaje = '';

            switch (tipoRegistro) {
                case 'realizada':
                    titulo = '<i class="fas fa-check-circle"></i> ¡Calificación Registrada!';
                    mensaje = 'Participante Evaluado correctamente';
                    break;
                default:
                    return;
            }

            modalTitulo.innerHTML = titulo;
            modalMensaje.innerText = mensaje;
            modal.style.display = 'block';

            document.querySelector('.modal .close').onclick = () => {
                modal.style.display = 'none';
                const url = new URL(window.location);
                url.searchParams.delete('calificacion');
                window.history.replaceState({}, document.title, url);
            };

            window.onclick = function(event) {
                if (event.target == modal) {
                    modal.style.display = 'none';
                    const url = new URL(window.location);
                    url.searchParams.delete('calificacion');
                    window.history.replaceState({}, document.title, url);
                }
            };
        }

        document.querySelectorAll('.btn-ver-calificaciones').forEach(btn => {
    btn.addEventListener('click', () => {
        const url = btn.getAttribute('data-url');
        const modalBody = document.getElementById('modal-calificaciones-body');
        modalBody.innerHTML = '<div class="text-center text-muted">Cargando calificaciones...</div>';

        fetch(url)
            .then(response => response.json())
            .then(data => {
                if (data.calificaciones.length === 0) {
                    modalBody.innerHTML = '<p class="text-center text-muted">No se encontraron calificaciones.</p>';
                } else {
                    let html = '<div class="row g-3">';
                    data.calificaciones.forEach(cal => {
                        html += `
                            <div class="col-md-6">
                                <div class="card shadow-sm border-orange hover-shadow">
                                    <div class="card-body">
                                        <h6 class="card-title text-orange">
                                            <i class="bi bi-check2-circle me-1"></i> ${cal.criterio} (${cal.peso}%)
                                        </h6>
                                        <p><strong>Puntaje:</strong> ${cal.puntaje}</p>
                                        ${cal.comentario ? `<p><strong>Comentario:</strong> ${cal.comentario}</p>` : ''}
                                    </div>
                                </div>
                            </div>`;
                    });
                    html += '</div>';
                    modalBody.innerHTML = html;
                }
            })
            .catch(() => {
                modalBody.innerHTML = '<p class="text-danger">Error al cargar calificaciones.</p>';
            });
    });
});
    });

</script>

{% endblock %}
