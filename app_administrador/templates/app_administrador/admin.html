{% extends "app_administrador/baseadmin.html" %}
{% load static %}

{% block content %}
<div class="contenedor-principal-de-eventos">
  {% for evento in eventos %}
  <div class="card" style="width: 18rem;">

    <img src="{{ evento.eve_imagen.url }}" class="card-img-top" alt="{{ evento.eve_nombre }}">

    <!-- Cuerpo de la Card -->
    <div class="card-body">
      <h5 class="card-title">{{ evento.eve_nombre }}</h5>
      <h6 class="card-subtitle mb-2 text-body-secondary">
        <i class="fa-solid fa-calendar"></i> {{ evento.eve_fecha_inicio }} - {{ evento.eve_fecha_fin }}
      </h6>
      <p class="card-text">{{ evento.eve_descripcion|truncatechars:100 }}</p>

      <div class="d-flex flex-column gap-1">
        <button class="btn-ver-mas" data-id="{{ evento.id }}">
          <i class="fa-solid fa-eye"></i> Ver más
        </button>

        <a href="{% url 'administrador:ver_participantes' evento_id=evento.id %}?estado=Pendiente"
          class="text-decoration-none">
          <button class="btn-ver_participantes w-100">
            <i class="fa-solid fa-users"></i> Participantes
          </button>
        </a>

        <a href="{% url 'administrador:ver_asistentes' evento_id=evento.id %}?estado=Pendiente"
          class="text-decoration-none">
          <button class="btn-ver_participantes w-100">
            <i class="fa-solid fa-users"></i> Asistentes
          </button>
        </a>

        <a href="{% url 'administrador:ver_evaluadores' evento_id=evento.id %}?estado=Pendiente"
          class="text-decoration-none">
          <button class="btn-ver_participantes w-100">
            <i class="fa-solid fa-chalkboard-user"></i> Evaluadores
          </button>
        </a>  
        


        <a href="{% url 'administrador:tabla_calificaciones' evento_id=evento.id %}" class="text-decoration-none">
          <button class="btn-ver_participantes w-100">
            <i class="fa-solid fa-trophy"></i> Tabla de Posiciones
          </button>
        </a>
        <button class="btn btn-primary btn-subir-info" 
        data-evento-id="{{ evento.id }}" 
        data-archivo-url="{% if evento.eve_informacion_tecnica %}{{ evento.eve_informacion_tecnica.url }}{% else %}{% endif %}"
        
        data-has-archivo="{{ evento.eve_informacion_tecnica|yesno:'1,0' }}"
        data-bs-toggle="modal" 
        data-bs-target="#modalSubirInfoTecnica">
          <i class="fa-solid fa-upload"></i> Subir Información Técnica
        </button>


        <a href="{% url 'administrador:enviar_correo' evento.id %}" class="text-decoration-none">
          <button class="btn-ver_participantes w-100">
            <i class="fa-regular fa-envelope"></i> Enviar Correo
          </button>
        </a>

        <!-- Botón Ver Estadística del Evento -->
         
        <button class="action-btn-outline btn-estadisticas btn-ver_participantes w-100 "  type="button" data-evento-id="{{ evento.id }}"
          data-inscritos="{{ evento.total_inscritos }}" data-asistentes="{{ evento.total_asistentes }}"
          data-participantes="{{ evento.total_participantes }}" data-evaluadores="{{ evento.total_evaluadores }}"
          data-fecha-inicio="{{ evento.eve_fecha_inicio }}" data-fecha-fin="{{ evento.eve_fecha_fin }}"
          data-lugar="{{ evento.eve_lugar }}" data-ciudad="{{ evento.eve_ciudad }}">
          <i class="fa-solid fa-magnifying-glass"></i> Ver estadística del Evento
        </button>
        
      </div>



    </div>
  </div>
  {% empty %}
  <div class="col-12 text-center">
    <p class="text-muted">No hay eventos disponibles.</p>
  </div>
  {% endfor %}
</div>


<!-- MODALES -->

<!-- Modal Detalle de Evento -->
<div class="modal fade" id="eventoModal" tabindex="-1" aria-labelledby="eventoModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="eventoModalLabel">Detalles del Evento</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
      </div>
      

      <div class="modal-body">
        <h5 id="modalNombre"></h5>
        <p><strong>Descripción:</strong> <span id="modalDescripcion"></span></p>
        <p><strong><i class="fa-solid fa-city"></i> Ciudad:</strong> <span id="modalCiudad"></span></p>
        <p><strong>Lugar:</strong> <span id="modalLugar"></span></p>
        <p><strong><i class="fa-solid fa-calendar-days"></i> Fecha:</strong> <span id="modalFecha"></span></p>
        <p><strong>Categoría:</strong> <span id="modalCategoria"></span></p>
        <p><strong><i class="fa-solid fa-users"></i> Aforo:</strong> <span id="modalAforo"></span></p>
        <p><strong>Inscripción:</strong> <span id="modalInscripcion"></span></p>
        <p><strong>Participantes:</strong> <span id="modalParticipantes"></span></p>
        <p><strong>Asistentes:</strong> <span id="modalAsistentes"></span></p>
        
        <p><strong>Memorias:</strong>
        <div id="modalMemorias"></div>
        </p>
        <img id="modalImagen" src="" alt="Imagen del evento" class="img-fluid"
          style="width: 100%; height: 300px; object-fit: contain;" />
      </div>
      <div class="modal-footer">
        <a type="button" id="btnModificar" class="btn-ver-mas" data-bs-dismiss="modal">Modificar información</a>
        <button type="button" id="btnCriterios" class="btn-eliminar" data-bs-dismiss="modal">Criterios de
          Evaluación</button>
        <button type="button" id="btnConfigCertificados" class="btn-eliminar" data-bs-dismiss="modal">Configuración de
          Certificados</button>
          
        <button type="button" class="btn-ver-mas" data-bs-toggle="modal" data-bs-target="#modalSubirMemorias">
          <i class="fa-solid fa-upload"></i> Subir memorias del evento
        </button>
        <button type="button" id="btnAccion" class="btn-eliminar" data-bs-dismiss="modal">Eliminar Evento</button>
      </div>
    </div>
  </div>
</div>

<!-- Modal Confirmar Eliminación -->
<div class="modal fade" id="confirmarEliminarModal" tabindex="-1" aria-labelledby="confirmarEliminarLabel"
  aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <!-- Header -->
      <div class="modal-header bg-danger text-white">
        <h5 class="modal-title" id="confirmarEliminarLabel">
          <i class="fa-solid fa-exclamation-triangle"></i> Confirmar Eliminación
        </h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Cerrar"></button>
      </div>
      <!-- Cuerpo -->
      <div class="modal-body text-center">
        <div class="mb-3">
          <i class="fa-solid fa-exclamation-triangle text-warning" style="font-size: 3rem;"></i>
        </div>
        <p class="fs-5">¿Estás seguro de que deseas eliminar este evento?</p>
        <p class="text-muted">Esta acción no se puede deshacer.</p>
      </div>
      <!-- Footer -->
      <div class="modal-footer justify-content-center">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
          <i class="fa-solid fa-times"></i> Cancelar
        </button>
        <button type="button" class="btn btn-danger" id="btnConfirmarEliminar">
          <i class="fa-solid fa-trash"></i> Eliminar
        </button>

      </div>
      
    </div>
  </div>
</div>

<!-- Modal Evento Modificado -->
<div id="modalEventoModificado" class="modal-modificar-evento" style="display:none;">
  <div class="modal-contenido-modificar-evento">
    <span id="cerrarModal" class="cerrar-modificar-evento">&times;</span>
    <h2>¡Éxito!</h2>
    <p>Evento modificado correctamente.</p>
  </div>
</div>

<!-- Modal Subir Memorias -->
<div class="modal fade" id="modalSubirMemorias" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <form id="form-guardar-memorias" method="POST" action="{% url 'administrador:guardar_memorias' %}">
      {% if evento.eve_memorias %}
      <input type="hidden" name="memorias_id" value="{{ evento.eve_memorias.id }}">
      {% else %}
      <input type="hidden" name="memorias_id" value="">
      {% endif %}
      {% csrf_token %}
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Subir memorias del evento</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
        </div>
        <div class="modal-body">
          <p>Ingresa la URL donde se encuentran las memorias del evento. Asegúrate de que el enlace sea accesible para
            los participantes.</p>
          <div id="linkMemorias"></div>
          <label for="url_memorias" class="form-label">URL del enlace (Google Drive, OneDrive, etc.):</label>
          <input type="url" name="url_memorias" id="url_memorias" class="form-control" required
            placeholder="https://drive.google.com/..." />
          <input type="hidden" name="evento_id" id="modalIdMemorias" value="{{ evento.id }}">
        </div>
        <div class="modal-footer">
          <button type="submit" class="btn btn-success">Guardar</button>
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
        </div>
      </div>
    </form>
  </div>
</div>

<!-- Modal Guardando Memorias -->
<div class="modal fade" id="modalGuardandoMemorias" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content text-center p-4">
      <div class="spinner-border text-success mb-3" role="status">
        <span class="visually-hidden">Cargando...</span>
      </div>
      <p class="fw-bold">Guardando enlace de memorias...</p>
    </div>
  </div>
</div>

<!-- Modal Memorias Guardadas -->
<div class="modal fade" id="modalMemoriasGuardadas" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content text-center p-4 position-relative">
      <button type="button" class="btn-close position-absolute top-0 end-0 m-3" data-bs-dismiss="modal"
        aria-label="Cerrar"></button>
      <i class="fas fa-check-circle fa-3x text-success mb-3"></i>
      <p class="fw-bold">¡Memorias guardadas exitosamente!</p>
    </div>
  </div>
</div>

<!-- Modal Estadísticas (vacío, rellenado por JS) -->
<!-- Modal Estadísticas con diseño Bootstrap -->
<div class="modal fade" id="modalEstadisticas" tabindex="-1" aria-labelledby="modalEstadisticasLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered modal-lg">
    <div class="modal-content">

      <div class="modal-header">
        <h5 class="modal-title" id="modalEstadisticasLabel">
          <i class="fa-solid fa-chart-column me-2"></i> Estadísticas del Evento
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
      </div>

      <div class="modal-body">
        <div class="row text-center">
          <div class="col-md-6 mb-3">
            <p class="fw-bold mb-1">Total de Inscritos</p>
            <p id="statInscritos" class="fs-5 text-primary">0</p>
          </div>
          <div class="col-md-6 mb-3">
            <p class="fw-bold mb-1"><i class="fas fa-user"></i> Asistentes</p>
            <p id="statAsistentes" class="fs-5 text-success">0</p>
          </div>
          <div class="col-md-6 mb-3">
            <p class="fw-bold mb-1"><i class="fas fa-pen"></i> Participantes</p>
            <p id="statParticipantes" class="fs-5 text-info">0</p>
          </div>
          <div class="col-md-6 mb-3">
            <p class="fw-bold mb-1"><i class="fas fa-chalkboard-teacher"></i> Evaluadores</p>
            <p id="statEvaluadores" class="fs-5 text-warning">0</p>
          </div>
        </div>

        <hr>

        <div class="row text-center">
          <div class="col-md-4 mb-2">
            <p class="fw-bold mb-1">📅 Fecha</p>
            <p id="statFecha">-</p>
          </div>
          <div class="col-md-4 mb-2">
            <p class="fw-bold mb-1">📍 Lugar</p>
            <p id="statLugar">-</p>
          </div>
          <div class="col-md-4 mb-2">
            <p class="fw-bold mb-1">🌆 Ciudad</p>
            <p id="statCiudad">-</p>
          </div>
        </div>
      </div>

      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
          <i class="fa-solid fa-times me-1"></i> Cerrar
        </button>
      </div>

    </div>
  </div>
</div>
<!-- Modal Subir Información Técnica -->
<div class="modal fade" id="modalSubirInfoTecnica" tabindex="-1" aria-labelledby="modalSubirInfoTecnicaLabel" aria-hidden="true">
  <div class="modal-dialog">
    <form method="post" enctype="multipart/form-data" id="formSubirInfoTecnica" action="{% url 'administrador:subir_info_tecnica' evento.id %}">
      {% csrf_token %}
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="modalSubirInfoTecnicaLabel">
            <i class="fa-solid fa-upload"></i> Subir Información Técnica
          </h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            <label for="archivoInfoTecnica" class="form-label">Selecciona un archivo PDF:</label>
            <input type="file" class="form-control" name="eve_informacion_tecnica" id="archivoInfoTecnica" accept="application/pdf" required>
          </div>
          <input type="hidden" name="evento_id" id="inputEventoIdTecnica">
          <div id="archivoActualInfoTecnica" class="alert alert-info d-none mt-3">
            Ya hay un archivo subido: <a href="#" id="linkArchivoActual" target="_blank">Ver archivo actual</a>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
          <button type="submit" class="btn btn-primary">Subir</button>
        </div>
      </div>
    </form>
  </div>
</div>

<script>
  document.addEventListener('DOMContentLoaded', function () {
    const subirInfoButtons = document.querySelectorAll('.btn-subir-info');
    const inputEventoId = document.getElementById('inputEventoIdTecnica');
    const archivoActualDiv = document.getElementById('archivoActualInfoTecnica');
    const archivoActualLink = document.getElementById('linkArchivoActual');
    const form = document.getElementById('formSubirInfoTecnica');

    subirInfoButtons.forEach(button => {
      button.addEventListener('click', () => {
        const eventoId = button.getAttribute('evento-id');
        const archivoUrl = button.getAttribute('archivo-url');
        const hasArchivo = button.getAttribute('has-archivo') === '1';

        inputEventoId.value = eventoId;

        if (hasArchivo && archivoUrl) {
          archivoActualDiv.classList.remove('d-none');
          archivoActualLink.href = archivoUrl;
        } else {
          archivoActualDiv.classList.add('d-none');
          archivoActualLink.href = '#';
        }

        console.log('Evento ID:', eventoId);
        console.log('Archivo URL:', archivoUrl);
        console.log('¿Tiene archivo?', hasArchivo);
        // Actualizar acción del formulario
        form.action =`/administrador/evento/${eventoId}/subir-info-tecnica/`.replace('eventoId', eventoId);
      });
    });
  });
</script>

<script>
document.addEventListener('DOMContentLoaded', () => {
  document.querySelectorAll('.btn-estadisticas').forEach(button => {
    button.addEventListener('click', () => {
      const inscritos = button.dataset.inscritos || '0';
      const asistentes = button.dataset.asistentes || '0';
      const participantes = button.dataset.participantes || '0';
      const evaluadores = button.dataset.evaluadores || '0';
      const fechaInicio = button.dataset.fechaInicio || '';
      const fechaFin = button.dataset.fechaFin || '';
      const lugar = button.dataset.lugar || '';
      const ciudad = button.dataset.ciudad || '';

      // Rellenar contenido del modal
      document.getElementById('statInscritos').textContent = inscritos;
      document.getElementById('statAsistentes').textContent = asistentes;
      document.getElementById('statParticipantes').textContent = participantes;
      document.getElementById('statEvaluadores').textContent = evaluadores;
      document.getElementById('statFecha').textContent = `${fechaInicio} al ${fechaFin}`;
      document.getElementById('statLugar').textContent = lugar;
      document.getElementById('statCiudad').textContent = ciudad;

      // Mostrar el modal
      const modal = new bootstrap.Modal(document.getElementById('modalEstadisticas'));
      modal.show();
    });
  });
});
</script>


<!-- SCRIPT -->
<script>
  // URLs base para acciones dinámicas (si usas luego en JS)
  const baseEventoDetalleUrl = "{% url 'administrador:evento_detalle' 0 %}".replace('0', '');
  const baseEliminarUrl = "{% url 'administrador:eliminar_evento' 0 %}".replace('0', '');
  const baseModificarUrl = "{% url 'administrador:editar_evento' 0 %}".replace('0', '');
  const baseCriteriosUrl = "{% url 'administrador:criterios_evaluacion' 0 %}".replace('0', '');
  const baseConfigCertificadosUrl = "{% url 'administrador:configuracion_certificados' 0 %}";

  



    // Manejar formulario memorias con modal cargando
    const formMemorias = document.getElementById('form-guardar-memorias');
    if (formMemorias) {
      formMemorias.addEventListener('submit', function (e) {
        e.preventDefault();

        const modalCargando = new bootstrap.Modal(document.getElementById('modalGuardandoMemorias'));
        modalCargando.show();

        setTimeout(() => {
          this.submit();
        }, 1000);
      });
    }

    // Mostrar modal éxito memorias si aplicable
    const params = new URLSearchParams(window.location.search);
    if (params.get("exito_memorias")) {
      const modalEl = document.getElementById('modalMemoriasGuardadas');
      const modal = new bootstrap.Modal(modalEl);
      modal.show();

      modalEl.addEventListener('hidden.bs.modal', function () {
        const url = new URL(window.location);
        url.searchParams.delete('exito_memorias');
        window.history.replaceState({}, document.title, url.toString());
      });
    }
  document.addEventListener('DOMContentLoaded', function () {
  const botonesVerMas = document.querySelectorAll('.btn-ver-mas');
  
  botonesVerMas.forEach(btn => {
    btn.addEventListener('click', function () {
      const eventoId = btn.getAttribute('data-id');

      // Establecer dinámicamente los enlaces
      const linkParticipantes = document.getElementById('linkHabilitarParticipantes');
      const linkEvaluadores = document.getElementById('linkHabilitarEvaluadores');

      if (linkParticipantes && linkEvaluadores) {
        linkParticipantes.href = `/administrador/habilitar_participantes/${eventoId}/`;
        linkEvaluadores.href = `/administrador/habilitar_evaluadores/${eventoId}/`;
      }

      // Aquí puedes abrir el modal si no lo haces aún
      const modal = new bootstrap.Modal(document.getElementById('eventoModal'));
      modal.show();
    });
  });
});

</script>

<script src="{% static 'app_administrador/js/verEventos.js' %}"></script>
<script src="{% static 'app_administrador/js/modificarEventos.js' %}"></script>
<script src="{% static 'app_administrador/js/Eliminar.js' %}"></script>
<script src="{% static 'app_administrador/js/modalModificarEvento.js' %}"></script>

{% endblock %}