{% extends "app_administrador/baseadmin.html" %}
{% load static %}

{% block content %}
<div class="contenedor-principal-de-eventos">
 
  <div class="gestion-eventos-header">
    <div class="crear-eventos-section">
      <h2 class="titulo-seccion">Gestión de Eventos</h2>
      {% if administrador.num_eventos > 0 %}
    <a href="{% url 'administrador:crear_evento' %}" class="btn-crear-evento">
      <i class="fa-solid fa-plus"></i> Crear Nuevo Evento
    </a>
  {% else %}
    <a class="btn-crear-evento btn-deshabilitado" title="Ya no puedes crear más eventos">
      <i class="fa-solid fa-plus"></i> Crear Nuevo Evento
    </a>
  {% endif %}
    </div>
    <div class="info-admin-eventos">
      <p>
        Tienes la opción de crear <strong>{{ administrador.num_eventos }}</strong> evento(s)
        y tu licencia de administrador de eventos va hasta el
        <strong>{{ administrador.tiempo_limite }}</strong>.
      </p>
    </div>
    
  </div>
<div class="eventos-header">
  <h1>Eventos</h1>
</div>

<div class="contenedor-eventos">
{% for evento in eventos %}
  <div class="card" style="width: 18rem;">

    <img src="{{ evento.eve_imagen.url }}" class="card-img-top" alt="{{ evento.eve_nombre }}">

    <!-- Cuerpo de la Card -->
    <div class="card-body">
      <h5 class="card-title">{{ evento.eve_nombre }}</h5>
      <h6 class="card-subtitle mb-2 text-body-secondary">
        <i class="fa-solid fa-calendar"></i> {{ evento.eve_fecha_inicio }} - {{ evento.eve_fecha_fin }}
      </h6>
      <p class="card-text">{{ evento.eve_descripcion|truncatechars:100 }}</p>

      <div class="d-flex flex-column gap-1">
        <button class="btn-ver-mas" data-id="{{ evento.id }}">
          <i class="fa-solid fa-eye"></i> Ver más
        </button>

        <a href="{% url 'administrador:ver_participantes' evento_id=evento.id %}?estado=Pendiente"
          class="text-decoration-none">
          <button class="btn-ver_participantes w-100">
            <i class="fa-solid fa-users"></i> Expositores
          </button>
        </a>

        <a href="{% url 'administrador:ver_asistentes' evento_id=evento.id %}?estado=Pendiente"
          class="text-decoration-none">
          <button class="btn-ver_participantes w-100">
            <i class="fa-solid fa-users"></i> Asistentes
          </button>
        </a>

        <a href="{% url 'administrador:ver_evaluadores' evento_id=evento.id %}?estado=Pendiente"
          class="text-decoration-none">
          <button class="btn-ver_participantes w-100">
            <i class="fa-solid fa-chalkboard-user"></i> Evaluadores
          </button>
        </a>  
        


        <a href="{% url 'administrador:tabla_calificaciones' evento_id=evento.id %}" class="text-decoration-none">
          <button class="btn-ver_participantes w-100">
            <i class="fa-solid fa-trophy"></i> Tabla de Posiciones
          </button>
        </a>

        <a href="{% url 'administrador:enviar_correo' evento.id %}" class="text-decoration-none">
          <button class="btn-ver_participantes w-100">
            <i class="fa-regular fa-envelope"></i> Enviar Correo
          </button>
        </a>

        <!-- Botón Ver Estadística del Evento --> 
       <button class="action-btn-outline btn-estadisticas btn-ver-estadisticas-evento w-100" 
        type="button" 
        data-evento-id="{{ evento.id }}"
        data-evento-nombre="{{ evento.eve_nombre }}"
        data-inscritos="{{ evento.total_inscritos }}" 
        data-asistentes="{{ evento.total_asistentes }}"
        data-participantes="{{ evento.total_participantes }}" 
        data-evaluadores="{{ evento.total_evaluadores }}"
        data-fecha-inicio="{{ evento.eve_fecha_inicio }}" 
        data-fecha-fin="{{ evento.eve_fecha_fin }}"
        data-lugar="{{ evento.eve_lugar }}" 
        data-ciudad="{{ evento.eve_ciudad }}">
    <i class="fa-solid fa-magnifying-glass"></i> Ver estadística del Evento
</button>
        
      </div>
    </div>
  </div>
  {% empty %}
  <div class="col-12 text-center">
    <p class="text-muted">No hay eventos disponibles.</p>
  </div>
  {% endfor %}
</div>
  
</div>


<!-- MODALES -->

<!-- Modal Detalle de Evento -->
<div class="modal fade" id="eventoModal" tabindex="-1" aria-labelledby="eventoModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="eventoModalLabel">Detalles del Evento</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
      </div>
      

      <div class="modal-body">
        <h5 id="modalNombre"></h5>
        <p><strong>Descripción:</strong> <span id="modalDescripcion"></span></p>
        <p><strong><i class="fa-solid fa-city"></i> Ciudad:</strong> <span id="modalCiudad"></span></p>
        <p><strong>Lugar:</strong> <span id="modalLugar"></span></p>
        <p><strong><i class="fa-solid fa-calendar-days"></i> Fecha:</strong> <span id="modalFecha"></span></p>
        <p><strong>Categoría:</strong> <span id="modalCategoria"></span></p>
        <p><strong><i class="fa-solid fa-users"></i> Aforo:</strong> <span id="modalAforo"></span></p>
        <p><strong>Inscripción:</strong> <span id="modalInscripcion"></span></p>
        <p><strong>Participantes:</strong> <span id="modalParticipantes"></span></p>
        <p><strong>Asistentes:</strong> <span id="modalAsistentes"></span></p>
        
        <img id="modalImagen" src="" alt="Imagen del evento" class="img-fluid"
          style="width: 100%; height: 300px; object-fit: contain;" />
      </div>
      <div class="modal-footer">
        <a type="button" id="btnModificar" class="btn-ver-mas" data-bs-dismiss="modal">Modificar información</a>
        <button type="button" id="btnCriterios" class="btn-ver_participantes" data-bs-dismiss="modal">Criterios de
          Evaluación</button>
        <button type="button" id="btnConfigCertificados" class="btn-ver_participantes" data-bs-dismiss="modal"><i class="fas fa-cog"></i> Configuración de
          Certificados</button>
        <button 
          type="button" 
          id="btnConfigInscripciones" 
          class="btn-ver_participantes" 
          data-bs-toggle="modal" 
          data-bs-target="#configModal">
          <i class="fas fa-cog"></i> Configuración de Inscripciones
        </button>
        <button type="button" class="btn-memorias" id="btnSubirMemorias">
          <i class="fa-solid fa-upload"></i> Subir memorias del evento
        </button>
        <button class="btn-ver_participantes w-100" 
        data-bs-toggle="modal" 
        data-bs-target="#modalSubirInfoTecnica" id="SubirFichaTecnica">
          <i class="fa-solid fa-upload"></i> Subir Información Técnica
        </button>
        <button type="button" id="btnAccion" class="btn-eliminar" data-bs-dismiss="modal">Eliminar Evento</button>
      </div>
    </div>
  </div>
</div>

<!-- Modal Confirmar Eliminación -->
<div class="modal fade" id="confirmarEliminarModal" tabindex="-1" aria-labelledby="confirmarEliminarLabel"
  aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <!-- Header -->
      <div class="modal-header bg-danger text-white">
        <h5 class="modal-title" id="confirmarEliminarLabel">
          <i class="fa-solid fa-exclamation-triangle"></i> Confirmar Eliminación
        </h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Cerrar"></button>
      </div>
      <!-- Cuerpo -->
      <div class="modal-body text-center">
        <div class="mb-3">
          <i class="fa-solid fa-exclamation-triangle text-warning" style="font-size: 3rem;"></i>
        </div>
        <p class="fs-5">¿Estás seguro de que deseas eliminar este evento?</p>
        <p class="text-muted">Esta acción no se puede deshacer.</p>
      </div>
      <!-- Footer -->
      <div class="modal-footer justify-content-center">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
          <i class="fa-solid fa-times"></i> Cancelar
        </button>
        <button type="button" class="btn btn-danger" id="btnConfirmarEliminar">
          <i class="fa-solid fa-trash"></i> Eliminar
        </button>

      </div>
      
    </div>
  </div>
</div>


<!-- Modal de confirmación Config Inscripción -->
<div class="modal fade" id="configModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title"><i class="fas fa-cog"></i> Configuración de Inscripción</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <div class="form-check form-switch mb-3">
  <input 
    class="form-check-input toggle-switch" 
    type="checkbox" 
    id="switchEvaluador" 
    data-role="Evaluador">
  <label class="form-check-label" for="switchEvaluador">Inscripción de Evaluador</label>
</div>

<div class="form-check form-switch">
  <input 
    class="form-check-input toggle-switch" 
    type="checkbox" 
    id="switchExpositor" 
    data-role="Expositor">
  <label class="form-check-label" for="switchExpositor">Inscripción de Expositor</label>
</div>

      </div>
    </div>
  </div>
</div>

<!-- Modal de confirmación config inscripcion -->
<div class="modal fade" id="confirmModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header bg-warning">
        <h5 class="modal-title"><i class="fas fa-exclamation-triangle"></i> Confirmación</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body" id="confirmMessage">
        ¿Seguro que deseas inactivar esta inscripción?
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
        <button type="button" class="btn btn-danger" id="confirmYes">Sí, inactivar</button>
      </div>
    </div>
  </div>
</div>

<!-- Modal Evento Modificado -->
<div id="modalEventoModificado" class="modal-modificar-evento" style="display:none;">
  <div class="modal-contenido-modificar-evento">
    <span id="cerrarModal" class="cerrar-modificar-evento">&times;</span>
    <h2>¡Éxito!</h2>
    <p>Evento modificado correctamente.</p>
  </div>
</div>

<!-- Modal Subir Memorias -->
<div class="modal fade" id="modalSubirMemorias" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <form id="form-guardar-memorias" method="POST" action="{% url 'administrador:guardar_memorias' %}">
      {% if evento.eve_memorias %}
      <input type="hidden" name="memorias_id" value="{{ evento.eve_memorias.id }}">
      {% else %}
      <input type="hidden" name="memorias_id" value="">
      {% endif %}
      {% csrf_token %}
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Subir memorias del evento</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
        </div>
        <div class="modal-body">
          <p>Ingresa la URL donde se encuentran las memorias del evento. Asegúrate de que el enlace sea accesible para
            los participantes.</p>
          <div id="linkMemorias"></div>
          <label for="url_memorias" class="form-label">URL del enlace (Google Drive, OneDrive, etc.):</label>
          <input type="url" name="url_memorias" id="url_memorias" class="form-control" required
            placeholder="https://drive.google.com/..." />
          <input type="hidden" name="evento_id" id="modalIdMemorias" value="{{ evento.id }}">
        </div>
        <div class="modal-footer">
          <button type="submit" class="btn btn-success">Guardar</button>
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
        </div>
      </div>
    </form>
  </div>
</div>

<!-- Modal Guardando Memorias -->
<div class="modal fade" id="modalGuardandoMemorias" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content text-center p-4">
      <div class="spinner-border text-success mb-3" role="status">
        <span class="visually-hidden">Cargando...</span>
      </div>
      <p class="fw-bold">Guardando enlace de memorias...</p>
    </div>
  </div>
</div>

<!-- Modal Memorias Guardadas -->
<div class="modal fade" id="modalMemoriasGuardadas" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content text-center p-4 position-relative">
      <button type="button" class="btn-close position-absolute top-0 end-0 m-3" data-bs-dismiss="modal"
        aria-label="Cerrar"></button>
      <i class="fas fa-check-circle fa-3x text-success mb-3"></i>
      <p class="fw-bold">¡Memorias guardadas exitosamente!</p>
    </div>
  </div>
</div>


<!-- Modal Estadísticas con diseño Bootstrap -->
<div class="modal fade" id="modalEstadisticas" tabindex="-1" aria-labelledby="modalEstadisticasLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered modal-lg">
    <div class="modal-content">

      <div class="modal-header">
        <h5 class="modal-title" id="modalEstadisticasLabel">
          <i class="fa-solid fa-chart-column me-2"></i> Estadísticas del Evento
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
      </div>

      <div class="modal-body">
        <div class="row text-center">
          <div class="col-md-6 mb-3">
            <p class="fw-bold mb-1">Total de Inscritos</p>
            <p id="statInscritos" class="fs-5 text-primary">0</p>
          </div>
          <div class="col-md-6 mb-3">
            <p class="fw-bold mb-1"><i class="fas fa-user"></i> Asistentes</p>
            <p id="statAsistentes" class="fs-5 text-success">0</p>
          </div>
          <div class="col-md-6 mb-3">
            <p class="fw-bold mb-1"><i class="fas fa-pen"></i> Participantes</p>
            <p id="statParticipantes" class="fs-5 text-info">0</p>
          </div>
          <div class="col-md-6 mb-3">
            <p class="fw-bold mb-1"><i class="fas fa-chalkboard-teacher"></i> Evaluadores</p>
            <p id="statEvaluadores" class="fs-5 text-warning">0</p>
          </div>
        </div>

        <hr>

        <div class="row text-center">
          <div class="col-md-4 mb-2">
            <p class="fw-bold mb-1">📅 Fecha</p>
            <p id="statFecha">-</p>
          </div>
          <div class="col-md-4 mb-2">
            <p class="fw-bold mb-1">📍 Lugar</p>
            <p id="statLugar">-</p>
          </div>
          <div class="col-md-4 mb-2">
            <p class="fw-bold mb-1">🌆 Ciudad</p>
            <p id="statCiudad">-</p>
          </div>
        </div>
      </div>

      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
          <i class="fa-solid fa-times me-1"></i> Cerrar
        </button>
      </div>

    </div>
  </div>
</div>
<!-- Modal Subir Información Técnica -->
<div class="modal fade" id="modalSubirInfoTecnica" tabindex="-1" aria-labelledby="modalSubirInfoTecnicaLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered modal-lg">
    <div class="modal-content rounded-4 shadow border-0">
      
      <!-- Header -->
      <div class="modal-header bg-success text-white rounded-top-4">
        <h5 class="modal-title fw-bold" id="modalSubirInfoTecnicaLabel">
          <i class="fa-solid fa-file-upload me-2"></i> Subir Ficha Técnica
        </h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Cerrar"></button>
      </div>

      <!-- Contenido -->
      <div class="modal-body">
        
        <!-- Estado de la ficha técnica -->
        <div id="fichaTecnicaSubida" class="mb-4">
        </div>

        <!-- Formulario -->
        <form id="formFichaTecnica" enctype="multipart/form-data">
          {% csrf_token %}
          <div class="mb-3">
            <label for="inputFichaTecnica" class="form-label fw-bold">Seleccionar archivo</label>
            <input type="file" id="inputFichaTecnica" name="eve_informacion_tecnica" accept=".pdf,.doc,.docx" class="form-control" required>
            <div class="form-text">Formatos permitidos: PDF, DOC, DOCX</div>
          </div>
          <input type="hidden" name="evento_id" id="eventoIdInput">
          
          <div class="d-flex justify-content-end gap-2 mt-4">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
              <i class="fa-solid fa-xmark me-1"></i> Cancelar
            </button>
            <button type="submit" class="btn-compartir">
              <i class="fa-solid fa-cloud-arrow-up me-1"></i> Subir
            </button>
          </div>
        </form>

      </div>
    </div>
  </div>
</div>


<!-- Modal de éxito -->
<div class="modal fade" id="modalExitoFicha" tabindex="-1" aria-labelledby="modalExitoFichaLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content rounded-4 shadow">
      <div class="modal-header bg-success text-white">
        <h5 class="modal-title" id="modalExitoFichaLabel">¡Éxito!</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
      </div>
      <div class="modal-body">
        La información técnica se subió exitosamente.
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-success" data-bs-dismiss="modal">Aceptar</button>
      </div>
    </div>
  </div>
</div>
<!-- Modal Estadísticas -->
<div id="modal-estadisticas-evento" class="modal-estadisticas-evento">
    <div class="modal-estadisticas-evento-content">
        <span class="modal-estadisticas-evento-close">&times;</span>
        <h2 id="modal-estadisticas-evento-titulo"></h2>
        <p><strong>📍 Lugar:</strong> <span id="modal-estadisticas-evento-lugar"></span> - <span id="modal-estadisticas-evento-ciudad"></span></p>
        <p><strong>🗓 Fecha inicio:</strong> <span id="modal-estadisticas-evento-fecha-inicio"></span></p>
        <p><strong>🗓 Fecha fin:</strong> <span id="modal-estadisticas-evento-fecha-fin"></span></p>

        <div class="modal-estadisticas-evento-stats">
            <div class="stat-card">
                <h3>Inscritos</h3>
                <p id="modal-estadisticas-evento-inscritos"></p>
            </div>
            <div class="stat-card">
                <h3>Asistentes</h3>
                <p id="modal-estadisticas-evento-asistentes"></p>
            </div>
            <div class="stat-card">
                <h3>Participantes</h3>
                <p id="modal-estadisticas-evento-participantes"></p>
            </div>
            <div class="stat-card">
                <h3>Evaluadores</h3>
                <p id="modal-estadisticas-evento-evaluadores"></p>
            </div>
        </div>
    </div>
</div>






<!-- SCRIPT -->
<script>
  // URLs base para acciones dinámicas (si usas luego en JS)
  const baseEventoDetalleUrl = "{% url 'administrador:evento_detalle' 0 %}".replace('0', '');
  const baseEliminarUrl = "{% url 'administrador:eliminar_evento' 0 %}".replace('0', '');
  const baseModificarUrl = "{% url 'administrador:editar_evento' 0 %}".replace('0', '');
  const baseCriteriosUrl = "{% url 'administrador:criterios_evaluacion' 0 %}".replace('0', '');
  const baseConfigCertificadosUrl = "{% url 'administrador:configuracion_certificados' 0 %}";
  const baseFichaTecnicaUrl = "{% url 'administrador:subir_info_tecnica' 123 %}";
  const baseModificarCertificadosUrl = "{% url 'administrador:modificar_certificados' 0 %}";
  const baseConfigInscripcionUrl = "{% url 'administrador:configurar_inscripcion' 0 %}";


    // Manejar formulario memorias con modal cargando
    const formMemorias = document.getElementById('form-guardar-memorias');
    if (formMemorias) {
      formMemorias.addEventListener('submit', function (e) {
        e.preventDefault();

        const modalCargando = new bootstrap.Modal(document.getElementById('modalGuardandoMemorias'));
        modalCargando.show();

        setTimeout(() => {
          this.submit();
        }, 1000);
      });
    }

    // Mostrar modal éxito memorias si aplicable
    const params = new URLSearchParams(window.location.search);
    if (params.get("exito_memorias")) {
      const modalEl = document.getElementById('modalMemoriasGuardadas');
      const modal = new bootstrap.Modal(modalEl);
      modal.show();

      modalEl.addEventListener('hidden.bs.modal', function () {
        const url = new URL(window.location);
        url.searchParams.delete('exito_memorias');
        window.history.replaceState({}, document.title, url.toString());
      });
    }
  document.addEventListener('DOMContentLoaded', function () {
  const botonesVerMas = document.querySelectorAll('.btn-ver-mas');
  
  botonesVerMas.forEach(btn => {
    btn.addEventListener('click', function () {
      const eventoId = btn.getAttribute('data-id');

      // Establecer dinámicamente los enlaces
      const linkParticipantes = document.getElementById('linkHabilitarParticipantes');
      const linkEvaluadores = document.getElementById('linkHabilitarEvaluadores');

      if (linkParticipantes && linkEvaluadores) {
        linkParticipantes.href = `/administrador/habilitar_participantes/${eventoId}/`;
        linkEvaluadores.href = `/administrador/habilitar_evaluadores/${eventoId}/`;
      }

      // Aquí puedes abrir el modal si no lo haces aún
      const modal = new bootstrap.Modal(document.getElementById('eventoModal'));
      modal.show();
    });
  });
});

</script>

<script src="{% static 'app_administrador/js/verEventos.js' %}"></script>
<script src="{% static 'app_administrador/js/modificarEventos.js' %}"></script>
<script src="{% static 'app_administrador/js/Eliminar.js' %}"></script>
<script src="{% static 'app_administrador/js/subir_ficha_tecnica.js' %}"></script>
<script src="{% static 'app_administrador/js/confgi_inscripcion.js' %}"></script>

{% endblock %}