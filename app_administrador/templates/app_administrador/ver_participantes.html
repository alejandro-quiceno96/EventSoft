{% load static %}
{% load tz %} {# Para usar el filtro timezone_now #}
<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestión de Participantes</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Work+Sans:wght@300;400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: "Work Sans";
            background-image: url(/static/app_administrador/image/fondo_admin.png);
            background-repeat: no-repeat;
            padding: 20px;
        }

        .btn-volver {
            background-color: #007832;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 5px;
            position: absolute;
            top: 20px;
            left: 20px;
            text-decoration: none;
        }

        .btn-volver:hover {
            background-color: #007832;
            color: white;
            transition: .5s ease;
        }


        .estado-asistentes {
            text-align: center;
            margin-bottom: 20px;
        }

        .estado-asistentes a {
            margin: 5px;
        }

      
        .container-titulos {
            text-align: center;
            margin-top: 50px;
            color: #007832;
        }
        /* Modal */
/* ---------------- Botón Asignar Evaluadores ---------------- */
.btn-asignar {
  background-color: #007832; /* color institucional */
  color: #fff;
  border: none;
  padding: 12px 20px;
  border-radius: 8px;
  font-size: 16px;
  font-family: 'Work Sans', sans-serif;
  font-weight: 600;
  cursor: pointer;
  display: inline-flex;
  align-items: center;
  gap: 8px;
  transition: background 0.3s ease, transform 0.2s ease;
}

.btn-asignar:hover {
  background-color: #005a27;
  transform: translateY(-2px);
}

.btn-asignar:active {
  transform: translateY(0);
}

/* ---------------- Modal ---------------- */
.modal {
  display: none; /* oculto por defecto */
  position: fixed;
  z-index: 1050;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background-color: rgba(0, 0, 0, 0.5); /* fondo oscuro */
  overflow: auto;
}

.modal-dialog {
  margin: 5% auto;
  max-width: 900px;
}

.modal-content {
  background: #fff;
  border-radius: 12px;
  box-shadow: 0 8px 25px rgba(0, 0, 0, 0.2);
  overflow: hidden;
  animation: fadeIn 0.3s ease;
}

.modal-header {
  background-color: #007832;
  color: #fff;
  padding: 15px 20px;
  font-family: 'Work Sans', sans-serif;
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.modal-header .modal-title {
  font-size: 18px;
  font-weight: 600;
}

.modal-header .btn-close {
  background: none;
  border: none;
  color: #fff;
  font-size: 20px;
  cursor: pointer;
}

.modal-body {
  padding: 20px;
}

.modal-footer {
  padding: 12px 20px;
  background: #f9f9f9;
  display: flex;
  justify-content: flex-end;
  gap: 10px;
}

/* Animación */
@keyframes fadeIn {
  from {opacity: 0; transform: translateY(-10px);}
  to {opacity: 1; transform: translateY(0);}
}

/* ---------------- Tabla ---------------- */
.table {
  width: 100%;
  border-collapse: collapse;
  font-family: 'Work Sans', sans-serif;
  margin-bottom: 0;
}

.table th {
  background-color: #007832;
  color: #fff;
  padding: 12px;
  text-align: left;
  font-size: 15px;
}

.table td {
  padding: 10px 12px;
  border-bottom: 1px solid #e5e5e5;
  font-size: 14px;
}

.table tr:hover {
  background-color: #f9f9f9;
}

/* Botón dentro de la tabla */
.btn-tabla {
  background-color: #007832;
  color: #fff;
  border: none;
  padding: 6px 12px;
  border-radius: 6px;
  font-size: 14px;
  cursor: pointer;
  transition: background 0.2s ease;
}

.btn-tabla:hover {
  background-color: #005a27;
}

    </style>
</head>

<body>
    <a href="{%url 'administrador:index_administrador'%}" class="btn btn-volver">Volver</a>
    <div class="container-titulos">
        <h1>Expositores del Evento</h1>
        <h4>{{ evento_nombre }}</h4>
    </div>

    <div class="estado-asistentes">
        <a href="?estado=Pendiente" class="btn btn-primary"><i class="fa-regular fa-clock"></i> Pendientes</a>
        <a href="?estado=Admitido" class="btn btn-success"><i class="fa-solid fa-check"></i> Admitidos</a>
        <a href="?estado=Rechazado" class="btn btn-danger"><i class="fa-solid fa-x"></i> Rechazados</a>
        {% if estado == 'Admitido' %}
            <div class="text-end mb-4 animate-fade-in">
                <button id="btnAbrirModalCertificados" class="btn btn-success me-3">
                <i class="fa-solid fa-envelope me-1"></i> Enviar certificados
                </button>
            </div>
        {% endif %}

    </div>

        <div class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-4">
            {% for proyecto in proyectos %}
            <div class="col">
                <div class="card h-100 border-0 shadow-lg rounded-4 bg-light position-relative overflow-hidden">
                    <!-- Estado en la esquina superior -->
                    <div class="position-absolute top-0 end-0 p-2">
                        {% if proyecto.estado == 'Admitido' %}
                        <span class="badge bg-success rounded-pill px-3 py-2 fs-6 shadow-sm">Admitido</span>
                        {% elif proyecto.estado == 'Pendiente' %}
                        <span class="badge bg-warning text-dark rounded-pill px-3 py-2 fs-6 shadow-sm">Pendiente</span>
                        {% else %}
                        <span class="badge bg-danger rounded-pill px-3 py-2 fs-6 shadow-sm">Rechazado</span>
                        {% endif %}
                    </div>

                    <div class="card-body">
                        <h5 class="card-title fw-bold mb-3">
                          <i class="fa-solid fa-id-badge me-2 mt-4"></i>{{ proyecto.pro_nombre }}
                        </h5>

                        <p><strong><i class="fa-regular fa-file-lines"></i> Descripción:</strong> {{proyecto.pro_descripcion}}</p>
                        <p><i class="fa-solid fa-users"></i><strong> Expositores:</strong> {{ proyecto.expositores|join:", " }}</p>
                        <p><i class="fa-solid fa-clock me-2 text-secondary"></i><strong>Hora de inscripción:</strong> {{proyecto.hora_inscripcion }}</p>

                        {% if proyecto.documentos %}
                        <a href="{{ proyecto.documentos.url }}" class="btn btn-outline-secondary w-100 mb-3"
                            target="_blank">
                            <i class="fa-solid fa-file me-2"></i> Ver Documento
                        </a>
                        {% else %}
                        <p class="text-muted small text-center">Sin documento</p>
                        {% endif %}

                        

                        <!-- Botones -->
                        <div class="d-flex justify-content-end gap-2 mt-4">
                            {% if proyecto.estado == 'Pendiente' or proyecto.estado == 'Rechazado' %}
                            <button class="btn btn-success btn-sm px-3 btn-admitir"
                                data-participante-id="{{ proyecto.pro_id}}" data-evento-id="{{ evento.id }}"
                                data-url="{% url 'administrador:actualizar_estado' 0 'estado-placeholder' %}">
                                <i class="fa-solid fa-check me-1"></i> Admitir
                            </button>
                            {% endif %}

                            {% if proyecto.estado == 'Pendiente' or proyecto.estado == 'Admitido' %}
                            {% if proyecto.estado == 'Admitido' %}
                        <!-- Botón que abre el modal -->
                        <button 
                            class="btn btn-success btn-abrir-evaluadores"
                            data-evento-id="{{ evento.id }}"
                            data-proyecto-id="{{ proyecto.pro_id }}">
                            Asignar Evaluadores
                        </button>

                        {% endif %}

                            <button class="btn btn-danger btn-sm px-3 btn-rechazar"
                                data-participante-id="{{ proyecto.pro_id }}" data-evento-id="{{ evento.id }}"
                                data-url="{% url 'administrador:actualizar_estado' 0 'estado-placeholder' %}">
                                <i class="fa-solid fa-xmark me-1"></i> Rechazar
                            </button>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>






      <div class="modal fade" id="modalRechazo" tabindex="-1" aria-labelledby="modalRechazoLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content shadow-lg rounded-4">
      <form id="formRechazo" method="POST">
        {% csrf_token %}
        <input type="hidden" name="evento_id" value="{{ evento.id }}">
        <input type="hidden" id="participanteRechazoId" name="participante_id">

        <div class="modal-header bg-danger text-white rounded-top-4">
          <h5 class="modal-title" id="modalRechazoLabel">
            <i class="fa-solid fa-triangle-exclamation me-2"></i> Confirmar Rechazo
          </h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Cerrar"></button>
        </div>

        <div class="modal-body text-center">
          <div class="mb-3">
            <i class="fa-solid fa-circle-exclamation text-warning" style="font-size: 3rem;"></i>
          </div>
          <p class="fs-5 fw-semibold mb-4">
            ¿Estás seguro de que deseas <span class="text-danger">rechazar</span> a este participante?
          </p>
          <div class="mb-3 text-start">
            <label for="razon-rechazo" class="form-label fw-semibold">
              <i class="fa-solid fa-comment-dots me-2"></i>Motivo del rechazo
            </label>
            <textarea name="razon-rechazo" id="razon-rechazo" class="form-control" rows="4"
              placeholder="Escribe las razones de rechazo aquí..." required></textarea>
          </div>
        </div>

        <div class="modal-footer justify-content-between px-4">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
            <i class="fa-solid fa-ban me-1"></i> Cancelar
          </button>
          <button id="btnRechazarConfirmacion" type="submit" class="btn btn-danger"
            data-url="{% url 'administrador:actualizar_estado' 0 'estado-placeholder' %}">
            <i class="fa-solid fa-xmark me-1"></i> Confirmar Rechazo
          </button>
        </div>
      </form>
    </div>
  </div>
</div>



        <!-- Loader personalizado -->
        <style>
            
            #loader-bg.d-none {
                display: none !important;
            }
        </style>

        <div id="loader-bg" class="d-none position-fixed top-0 start-0 w-100 h-100 bg-white bg-opacity-75"
            style="z-index:9999;">
            <div id="loader" class="d-flex flex-column justify-content-center align-items-center h-100">
                <div class="spinner-border" style="width:3rem; height:3rem; color:#007832;" role="status"></div>
                <p class="mt-3 fw-bold" style="color:#007832; font-size:1.2rem;">Procesando solicitud...</p>
            </div>
        </div>
        <!-- Modal de Confirmación para Enviar Certificados -->
<div class="modal fade" id="modalEnviarCertificados" tabindex="-1" aria-labelledby="modalCertificadosLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content shadow-lg rounded-4">
      <div class="modal-header bg-success text-white rounded-top-4">
        <h5 class="modal-title" id="modalCertificadosLabel">
          <i class="fa-solid fa-paper-plane me-2"></i> Confirmar envío
        </h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Cerrar"></button>
      </div>

      <div class="modal-body text-center">
        <i class="fa-solid fa-envelope-circle-check text-success" style="font-size: 3rem;"></i>
        <p class="fs-5 fw-semibold mt-3">
          ¿Estás seguro de que deseas enviar los certificados a todos los participantes admitidos?
        </p>
      </div>

      <div class="modal-footer justify-content-between px-4">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
          <i class="fa-solid fa-ban me-1"></i> Cancelar
        </button>
        <button id="btnConfirmarEnvioCertificados" class="btn btn-success">
          <i class="fa-solid fa-paper-plane me-1"></i> Confirmar Envío
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Modal de Éxito -->
<div class="modal fade" id="modalEnvioExitoso" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content text-center p-4">
      <i class="fas fa-check-circle fa-3x text-success mb-3"></i>
      <p class="fw-bold fs-5" style="color: #007832;">¡Certificados enviados exitosamente!</p>
      <button type="button" class="btn btn-success mt-2 px-4" data-bs-dismiss="modal">
        Aceptar
      </button>
    </div>
  </div>
</div>
<!-- Modal: Advertencia si aún no ha pasado la fecha -->
<div class="modal fade" id="modalFechaNoValida" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content text-center p-4">
      <i class="fa-solid fa-circle-exclamation fa-3x text-warning mb-3"></i>
      <p class="fw-bold fs-5 text-dark">No puedes enviar certificados antes de que finalice el evento.</p>
      <p class="text-secondary">La fecha de finalización es: <strong>{{ evento.eve_fecha_fin|date:"d \\d\\e F \\d\\e Y" }}</strong></p>
      <button type="button" class="btn btn-secondary mt-2 px-4" data-bs-dismiss="modal">
        Entendido
      </button>
    </div>
  </div>
</div>

<!-- Modal Evaluadores -->
<div id="modalEvaluadores" class="modal" tabindex="-1">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      
      <!-- Header -->
      <div class="modal-header">
        <h5 class="modal-title"><i class="fas fa-user-check"></i> Asignar Evaluadores</h5>
        <button type="button" class="btn-close" aria-label="Cerrar" onclick="cerrarModalAsignar()"></button>
      </div>

      <!-- Body -->
      <div class="modal-body">
        <div class="table-responsive">
          <table class="table table-bordered table-hover align-middle">
            <thead class="table-dark">
              <tr>
                <th>Nombre</th>
                <th>Área</th>
                <th class="text-center">Acción</th>
              </tr>
            </thead>
            <tbody id="tablaEvaluadores">
              <!-- 🔹 Aquí se insertan las filas dinámicamente desde JS -->
            </tbody>
          </table>
        </div>
      </div>

      <!-- Footer -->
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" onclick="cerrarModalAsignar()">
          <i class="fas fa-times"></i> Cerrar
        </button>
      </div>

    </div>
  </div>
</div>




        <script src="{% static 'app_administrador/js/aceptar_participante.js'%}"></script>
        <script src="{% static 'app_administrador/js/traer_evaluadores.js'%}"></script>
        <script>
            const UrlEnvioCertificados = "{% url 'administrador:enviar_certificado_participantes' evento.id %}";
            const eventoFechaFin = new Date("{{ evento_fecha_fin }}T00:00:00"); // solo si es DateField
            const fechaActual = new Date("{{ fecha_actual }}"); // DateTime
            const urlListarEvaluadores = "{% url 'administrador:listar_evaluadores' 123 456 %}";
            const urlAsignarEvaluador = "{% url 'administrador:asignar_evaluador' 123 456 789 %}";
        </script>
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>

</html>